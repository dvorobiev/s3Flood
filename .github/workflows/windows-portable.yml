name: windows-portable

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-portable:
    runs-on: windows-latest  # Используем Windows для корректной работы с Windows-специфичными файлами

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Download Python embedded
        shell: pwsh
        run: |
          $PYTHON_VERSION = "3.11.9"
          $PYTHON_EMBED_URL = "https://www.python.org/ftp/python/$PYTHON_VERSION/python-$PYTHON_VERSION-embed-amd64.zip"
          New-Item -ItemType Directory -Path "dist-portable" -Force | Out-Null
          Invoke-WebRequest -Uri $PYTHON_EMBED_URL -OutFile "dist-portable\python-embed.zip"

      - name: Prepare portable distribution
        shell: pwsh
        run: |
          cd dist-portable
          
          # Распаковываем Python embedded
          Expand-Archive -Path python-embed.zip -DestinationPath . -Force
          Remove-Item python-embed.zip
          
          # Скачиваем и устанавливаем pip
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          python.exe get-pip.py --no-warn-script-location --target=.
          Remove-Item get-pip.py
          
          # Исправляем python311._pth чтобы загружать модули из site-packages
          # Раскомментируем import site
          (Get-Content python311._pth) -replace '#import site', 'import site' | Set-Content python311._pth
          
          # Устанавливаем зависимости прямо в корень Python embedded (чтобы были доступны по умолчанию)
          # Python embedded ищет модули в текущей директории и в Lib/site-packages
          New-Item -ItemType Directory -Path "Lib\site-packages" -Force | Out-Null
          
          # Устанавливаем зависимости через pip прямо в Python embedded
          python.exe -m pip install --target=Lib\site-packages pydantic rich pyyaml --no-warn-script-location
          
          # Устанавливаем s3flood
          cd ..
          python.exe -m pip install --target=dist-portable\Lib\site-packages -e . --no-warn-script-location
          
          cd dist-portable

      - name: Copy project files
        shell: pwsh
        run: |
          cd dist-portable
          New-Item -ItemType Directory -Path "s3flood" -Force | Out-Null
          Copy-Item -Path "..\src\s3flood\*" -Destination "s3flood\" -Recurse -Force
          Copy-Item -Path "..\config.sample.yaml" -Destination "."
          Copy-Item -Path "..\README.md" -Destination "."

      - name: Create batch scripts
        shell: pwsh
        run: |
          cd dist-portable
          
          # s3flood.bat - основной скрипт
          # Устанавливаем PYTHONPATH чтобы Python находил модули в Lib/site-packages
          $batContent = "@echo off`nsetlocal`n`nREM Определяем директорию скрипта`nset `"SCRIPT_DIR=%~dp0`"`ncd /d `"%SCRIPT_DIR%`"`n`nREM Устанавливаем PYTHONPATH для поиска модулей`nset `"PYTHONPATH=%SCRIPT_DIR%Lib\site-packages;%PYTHONPATH%`"`n`nREM Запускаем через Python embedded`npython.exe -m s3flood %*"
          $batContent | Out-File -FilePath "s3flood.bat" -Encoding ASCII
          
          # Создаём инструкцию
          $installText = "s3flood Portable для Windows`n============================`n`nЭто portable версия s3flood - не требует установки Python.`n`nИспользование:`n1. Распакуйте архив в любую папку (например, C:\s3flood-portable)`n2. Убедитесь, что AWS CLI установлен и доступен в PATH`n3. Запускайте команды через s3flood.bat:`n`n   s3flood.bat dataset-create --path .\loadset --target-bytes 5GB`n   s3flood.bat run --profile write --endpoint http://localhost:9000 --bucket test`n`nИли напрямую через Python:`n   python.exe -m s3flood --help`n`nТребования:`n- Windows 10/11 (64-bit)`n- AWS CLI должен быть установлен отдельно`n`nПримечание: Python embedded включён в этот дистрибутив, дополнительная установка не требуется."
          $installText | Out-File -FilePath "INSTALL.txt" -Encoding UTF8

      - name: Create ZIP archive
        shell: pwsh
        run: |
          Compress-Archive -Path dist-portable\* -DestinationPath s3flood-windows-portable.zip -Force
          $size = (Get-Item s3flood-windows-portable.zip).Length
          Write-Host "✅ ZIP создан, размер: $([math]::Round($size/1MB, 2)) MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: s3flood-windows-portable
          path: s3flood-windows-portable.zip

      - name: Attach portable bundle to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: s3flood-windows-portable.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

