name: windows-portable

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-portable:
    runs-on: windows-latest  # Используем Windows для корректной работы с Windows-специфичными файлами

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Download Python embedded
        shell: pwsh
        run: |
          $PYTHON_VERSION = "3.11.9"
          $PYTHON_EMBED_URL = "https://www.python.org/ftp/python/$PYTHON_VERSION/python-$PYTHON_VERSION-embed-amd64.zip"
          New-Item -ItemType Directory -Path "dist-portable" -Force | Out-Null
          Invoke-WebRequest -Uri $PYTHON_EMBED_URL -OutFile "dist-portable\python-embed.zip"

      - name: Prepare portable distribution
        shell: pwsh
        run: |
          cd dist-portable
          
          # Распаковываем Python embedded
          Expand-Archive -Path python-embed.zip -DestinationPath . -Force
          Remove-Item python-embed.zip
          
          # Скачиваем и устанавливаем pip
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          python.exe get-pip.py --no-warn-script-location --target=.
          Remove-Item get-pip.py
          
          # Создаём структуру для venv
          New-Item -ItemType Directory -Path "venv\Lib\site-packages" -Force | Out-Null
          New-Item -ItemType Directory -Path "venv\Scripts" -Force | Out-Null
          
          # Копируем Python в venv Scripts для удобства
          Copy-Item python*.exe venv\Scripts\ -ErrorAction SilentlyContinue
          Copy-Item python*.dll venv\Scripts\ -ErrorAction SilentlyContinue
          
          # Создаём активационный скрипт
          $activateContent = "@echo off`nset `"VIRTUAL_ENV=%~dp0..`"`nset `"PATH=%VIRTUAL_ENV%\Scripts;%PATH%`""
          $activateContent | Out-File -FilePath "venv\Scripts\activate.bat" -Encoding ASCII
          
          # Устанавливаем зависимости через pip
          python.exe -m pip install --target=venv\Lib\site-packages pydantic rich pyyaml --no-warn-script-location
          
          # Устанавливаем s3flood
          cd ..
          python.exe -m pip install --target=dist-portable\venv\Lib\site-packages -e . --no-warn-script-location
          
          cd dist-portable

      - name: Copy project files
        shell: pwsh
        run: |
          cd dist-portable
          New-Item -ItemType Directory -Path "s3flood" -Force | Out-Null
          Copy-Item -Path "..\src\s3flood\*" -Destination "s3flood\" -Recurse -Force
          Copy-Item -Path "..\config.sample.yaml" -Destination "."
          Copy-Item -Path "..\README.md" -Destination "."

      - name: Create batch scripts
        shell: pwsh
        run: |
          cd dist-portable
          
          # s3flood.bat - основной скрипт
          $batContent = "@echo off`nsetlocal`n`nREM Определяем директорию скрипта`nset `"SCRIPT_DIR=%~dp0`"`ncd /d `"%SCRIPT_DIR%`"`n`nREM Запускаем через Python embedded`npython.exe -m s3flood %*"
          $batContent | Out-File -FilePath "s3flood.bat" -Encoding ASCII
          
          # Создаём инструкцию
          $installLines = @(
            "s3flood Portable для Windows",
            "============================",
            "",
            "Это portable версия s3flood - не требует установки Python.",
            "",
            "Использование:",
            "1. Распакуйте архив в любую папку (например, C:\s3flood-portable)",
            "2. Убедитесь, что AWS CLI установлен и доступен в PATH",
            "3. Запускайте команды через s3flood.bat:",
            "",
            "   s3flood.bat dataset-create --path .\loadset --target-bytes 5GB",
            "   s3flood.bat run --profile write-heavy --endpoint http://localhost:9000 --bucket test",
            "",
            "Или напрямую через Python:",
            "   python.exe -m s3flood --help",
            "",
            "Требования:",
            "- Windows 10/11 (64-bit)",
            "- AWS CLI должен быть установлен отдельно",
            "",
            "Примечание: Python embedded включён в этот дистрибутив, дополнительная установка не требуется."
          )
          $installLines -join "`n" | Out-File -FilePath "INSTALL.txt" -Encoding UTF8

      - name: Create ZIP archive
        shell: pwsh
        run: |
          Compress-Archive -Path dist-portable\* -DestinationPath s3flood-windows-portable.zip -Force
          $size = (Get-Item s3flood-windows-portable.zip).Length
          Write-Host "✅ ZIP создан, размер: $([math]::Round($size/1MB, 2)) MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: s3flood-windows-portable
          path: s3flood-windows-portable.zip

      - name: Attach portable bundle to Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: s3flood-windows-portable.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

